<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="mmrm">
<title>Predicting from a MMRM â€¢ mmrm</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Predicting from a MMRM">
<meta property="og:description" content="mmrm">
<meta property="og:image" content="https://openpharma.github.io/mmrm/logo.svg">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-125641273-1"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-125641273-1');
</script>
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">mmrm</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.2.2.9037</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/algorithm.html">Details of the Model Fitting in `mmrm`</a>
    <a class="dropdown-item" href="../articles/coef_vcov.html">Coefficients Covariance Matrix Adjustment in `mmrm`</a>
    <a class="dropdown-item" href="../articles/covariance.html">Covariance Structures in `mmrm`</a>
    <a class="dropdown-item" href="../articles/empirical_wls.html">Weighted Least Square Empirical Covariance</a>
    <a class="dropdown-item" href="../articles/introduction.html">Introduction to `mmrm`</a>
    <a class="dropdown-item" href="../articles/kenward.html">Details of the Kenward-Roger calculations</a>
    <a class="dropdown-item" href="../articles/methodological_introduction.html">What are MMRMs? A brief introduction</a>
    <a class="dropdown-item" href="../articles/mmrm_review_methods.html">Implementations of MMRM: a comparison of what's available</a>
    <a class="dropdown-item" href="../articles/package_structure.html">Package Structure</a>
    <a class="dropdown-item" href="../articles/predict.html">Predicting from a MMRM</a>
    <a class="dropdown-item" href="../articles/satterthwaite.html">Details of the Satterthwaite calculations</a>
    <a class="dropdown-item" href="../articles/subsections/intro-acknowledgments.html">UNKNOWN TITLE</a>
    <a class="dropdown-item" href="../articles/subsections/intro-customizations.html">UNKNOWN TITLE</a>
    <a class="dropdown-item" href="../articles/subsections/intro-getting_started.html">UNKNOWN TITLE</a>
    <a class="dropdown-item" href="../articles/subsections/intro-hypothesis_testing.html">UNKNOWN TITLE</a>
    <a class="dropdown-item" href="../articles/subsections/intro-lower_level.html">UNKNOWN TITLE</a>
    <a class="dropdown-item" href="../articles/subsections/intro-model_features.html">UNKNOWN TITLE</a>
    <a class="dropdown-item" href="../articles/subsections/intro-tidymodels.html">UNKNOWN TITLE</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
<!-- start dropdown for versions --> <li class="nav-item dropdown">
        <a href="#" class="nav-link dropdown-toggle"
          data-bs-toggle="dropdown" role="button"
          aria-expanded="false" aria-haspopup="true"
          id="dropdown-versions">Versions</a> <div class="dropdown-menu" aria-labelledby="dropdown-versions"> <a class="dropdown-item" data-toggle="tooltip" title="" href="https://openpharma.github.io/mmrm/latest-tag">latest-tag</a>
<a class="dropdown-item" data-toggle="tooltip" title="" href="https://openpharma.github.io/mmrm/main">main</a>
<a class="dropdown-item" data-toggle="tooltip" title="" href="https://openpharma.github.io/mmrm/v0.2.2">v0.2.2</a> </div></li>
<!-- end dropdown for versions -->
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-reports">Reports</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-reports">
    <a class="dropdown-item" href="../coverage-report/">Coverage report</a>
    <a class="dropdown-item" href="../unit-test-report/">Unit test report</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/openpharma/mmrm">
    <span class="fa fa-github"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.svg" class="logo" alt=""><h1>Predicting from a MMRM</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/openpharma/mmrm/blob/HEAD/vignettes/predict.Rmd" class="external-link"><code>vignettes/predict.Rmd</code></a></small>
      <div class="d-none name"><code>predict.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="prediction-of-conditional-mean">Prediction of conditional mean<a class="anchor" aria-label="anchor" href="#prediction-of-conditional-mean"></a>
</h2>
<div class="section level3">
<h3 id="mathematical-derivations">Mathematical Derivations<a class="anchor" aria-label="anchor" href="#mathematical-derivations"></a>
</h3>
<p>Since residuals can be correlated, potentially existing observed
outcomes of the same individual can be informative for predicting the
unobserved valued of the same individual.</p>
<p>Assume that the data is sorted such that <span class="math inline">\(Y_{ij} = y_{ij}, j = k+1, k+2, \dots, p\)</span>
are observed and <span class="math inline">\(Y_{ij}, j = 1, 2, \dots,
k\)</span> are not. The special case of all outcomes being unobserved
(new individual) is covered with <span class="math inline">\(k=p\)</span>.</p>
<p>Let further <span class="math display">\[
\Sigma_i(X_i, \theta) = \begin{pmatrix} \Sigma_i^{new,new}(X_i,\theta)
&amp; \Sigma_i^{new,old}(X_i,\theta)\\ \Sigma_i^{old,new}(X_i,\theta)
&amp; \Sigma_i^{old,old}(X_i,\theta)\end{pmatrix}
\]</span></p>
<p>be a block decomposition where <span class="math inline">\(\Sigma_i^{new,new}(X_i,\theta) =
\Big(\big(\Sigma_i(X_i,\theta)\big)_{j,l}\Big)_{j = 1\dots k,\, l =
1\ldots k}\)</span> and similarly for the other blocks.</p>
<p>Predictions can then be made based on the conditional distribution
<span class="math display">\[
Y_{i, 1\ldots k}\,|\,X_i,Y_{i,k+1\ldots p}=y_{i, k+1\ldots
p}\sim\mathcal{N}(\mu_i, A_i)
\]</span></p>
<p>with</p>
<p><span class="math display">\[
\mu_i(\beta,\theta) = (X_i \ \beta)_{1\ldots k}
+  \Sigma_i^{new,old}(X_i,\theta) \,
\Big(\big(\Sigma_i^{old,old}(X_i,\theta)\big)^{-1} \big(y_i^{k+1\ldots
p} -  (X_i \ \beta)_{k+1\ldots p}\big)\Big)
\]</span> and</p>
<p><span class="math display">\[
A_i(\beta, \theta) = \Sigma_i^{new,new}(X_i,\theta) -
\Sigma_i^{old,new}(X_i,\theta)
\Big(\Sigma_i^{old,old}(X_i,\theta)\Big)^{-1}
\Sigma_i^{new,old}(X_i,\theta) \ .
\]</span> Note that <span class="math inline">\(A_i\)</span> does not
depend on <span class="math inline">\(\beta\)</span>.</p>
</div>
<div class="section level3">
<h3 id="implementation-of-predict">Implementation of <code>predict</code><a class="anchor" aria-label="anchor" href="#implementation-of-predict"></a>
</h3>
<p>For implementing <code><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict()</a></code>, only <span class="math inline">\(\widehat{\mu}_i:=\mu_i(\widehat{\beta},\widehat{\theta})\)</span>
is required.</p>
<p>For <code>predict(interval = "confidence")</code> additionally
standard errors are required. These could be derived using the delta
methods since <span class="math inline">\(\mu_i\)</span> is a function
of the estimated model parameters <span class="math inline">\(\beta\)</span> and <span class="math inline">\(\theta\)</span>. This would require the Jacobian
<span class="math inline">\(\nabla\mu_i(\beta,\theta)|_{\big(\widehat{\beta},\widehat{\theta}\big)}\)</span>
in addition to the estimated variance covariance matrix of the parameter
estimate <span class="math inline">\(\big(\widehat{\beta},\widehat{\theta}\big)\)</span>,
<span class="math inline">\(\widehat{S}\)</span>. Standard errors for
<span class="math inline">\(\widehat{\mu}^{\,(i)}\)</span> are then
given by the square root of the diagonal elements of <span class="math display">\[
\Big(\nabla\mu_i(\beta,\theta)|_{\big(\widehat{\beta},\widehat{\theta}\big)}\Big)^\top\quad
\widehat{S} \quad
\Big(\nabla\mu_i(\beta,\theta)|_{\big(\widehat{\beta},\widehat{\theta}\big)}\Big)
\]</span> For <code>predict(interval = "prediction")</code> one would
use the square root of the diagonal elements of <span class="math inline">\(A_i\big(\widehat{\beta},\widehat{\theta}\big)\)</span>
instead. The delta method could again be used to make upper and lower
boundaries reflect parameter estimation uncertainty.</p>
<p>Alternatively, both intervals can be derived using a parametric
bootstrap sample of the unrestricted parameters <span class="math inline">\(\theta\)</span>. This would probably also be
easier for the <code>= "prediction"</code> case.</p>
<p>Please note that for these intervals, we assume that the distribution
is approximately normal: we use <span class="math inline">\(\mu_{i,j}(\hat\beta, \hat\theta) \pm Z_{\alpha} *
sqrt(A_{i, j, j}(\hat\beta, \hat\theta))\)</span> to construct it, where
<span class="math inline">\(\mu_{i,j}(\hat\beta, \hat\theta)\)</span> is
the <span class="math inline">\(j\)</span>th element of <span class="math inline">\(\mu_i(\hat\beta, \hat\theta)\)</span>, <span class="math inline">\(A_{i, j, j}(\hat\beta, \hat\theta)\)</span> is the
<span class="math inline">\(j,j\)</span> element of <span class="math inline">\(A_i(\hat\beta, \hat\theta)\)</span>.</p>
</div>
<div class="section level3">
<h3 id="parametric-sampling-for-prediction-interval">Parametric Sampling for prediction interval<a class="anchor" aria-label="anchor" href="#parametric-sampling-for-prediction-interval"></a>
</h3>
<p>With the conditional variance formula</p>
<p><span class="math display">\[
  Var(Y_i) = Var(E(Y_i|\theta)) + E(Var(Y_i|\theta))
\]</span></p>
<p>the conditional expectation <span class="math inline">\(E(Y_i|\theta)\)</span> and the conditional
variance <span class="math inline">\(Var(Y_i|\theta)\)</span> are
already described</p>
<p><span class="math display">\[
  E(Y_i|\theta) = \mu_i(\beta,\theta)
\]</span></p>
<p><span class="math display">\[
  Var(Y_i|\theta) = A_i(\beta, \theta)
\]</span></p>
<p>so we can sample on <span class="math inline">\(\theta\)</span> and
obtain <span class="math inline">\(\beta\)</span>, then calculate the
variance of conditional mean and the mean of conditional variance.</p>
</div>
<div class="section level3">
<h3 id="prediction-of-conditional-mean-for-new-subjects">Prediction of conditional mean for new subjects<a class="anchor" aria-label="anchor" href="#prediction-of-conditional-mean-for-new-subjects"></a>
</h3>
<p>If there are no observations for a subject, then the prediction is
quite simple:</p>
<p><span class="math display">\[
  Y_i = X_i \hat\beta
\]</span></p>
</div>
</div>
<div class="section level2">
<h2 id="simulate-response">Simulate response<a class="anchor" aria-label="anchor" href="#simulate-response"></a>
</h2>
<p>To create simulation of responses from a fitted model, we have
multiple situations: whether this simulation is conditional on both
<span class="math inline">\(\theta\)</span> and <span class="math inline">\(\beta\)</span>, or it is marginal?</p>
<div class="section level3">
<h3 id="conditional-simulation">Conditional Simulation<a class="anchor" aria-label="anchor" href="#conditional-simulation"></a>
</h3>
<p>Under conditional simulation setting, the variance-covariance matrix,
and the expectation of <span class="math inline">\(Y_i\)</span> are
already given in <a href="#Mathematical-Derivations">Mathematical
Derivations</a>.</p>
<p>Please note that in implementation of <code>predict</code> function,
we only use the diagonal elements, however, here we need to make use of
the full matrix <span class="math inline">\(A_i\)</span>.</p>
</div>
<div class="section level3">
<h3 id="marginal-simulation">Marginal Simulation<a class="anchor" aria-label="anchor" href="#marginal-simulation"></a>
</h3>
<p>To simulate marginally, we take the variance of <span class="math inline">\(\hat\theta\)</span> and <span class="math inline">\(\hat\beta\)</span> into consideration. For each
simulation, we first generate <span class="math inline">\(\theta\)</span> assuming it approximately follows
multi-variate normal distribution. Then, conditional on <span class="math inline">\(\theta\)</span> we sampled, we generate <span class="math inline">\(\beta\)</span> also assuming it approximately
follows multi-variate normal distribution. Now we have <span class="math inline">\(\theta\)</span> and <span class="math inline">\(\beta\)</span> estimates, and we just follow the
<a href="#conditional-simulation">conditional simulation</a>. Repeat
this step for multiple times and this is the marginal simulated
response.</p>
</div>
<div class="section level3">
<h3 id="implementation-of-simulate">Implementation of <code>simulate</code><a class="anchor" aria-label="anchor" href="#implementation-of-simulate"></a>
</h3>
<p>To implement <code>simulate</code> function, we first ensure that the
expectation (<span class="math inline">\(\mu\)</span>) and
variance-covariance matrix (<span class="math inline">\(A\)</span>) are
generated in <code>predict</code> function, for each of the
subjects.</p>
<p>For <code>simulate(method = "conditional")</code>, we use the
estimated <span class="math inline">\(\theta\)</span> and <span class="math inline">\(\beta\)</span> to construct the <span class="math inline">\(\mu\)</span> and <span class="math inline">\(A\)</span> directly, and generate response with
<span class="math inline">\(N(\mu, A)\)</span> distribution.</p>
<p>For <code>simulate(method = "marginal")</code>, for each repetition
of simulation, we generate <span class="math inline">\(\theta_{new}\)</span> from the mmrm fit, where the
estimate of <span class="math inline">\(\theta\)</span> and
variance-covariance matrix of <span class="math inline">\(\theta\)</span> are provided. Using the generated
<span class="math inline">\(\theta_{new}\)</span>, we then obtain the
<span class="math inline">\(\beta_{new}\)</span> and its
variance-covariance matrix, with <span class="math inline">\(\theta_{new}\)</span> and the data used in fit.
Then we simulate once with
<code>simulate(method = "conditional", beta = beta_new, theta = theta_new)</code>.
Pool all the repetition together and we get the marginal simulation
results.</p>
</div>
</div>
<div class="section level2">
<h2 id="comparison-with-sas">Comparison with <code>SAS</code><a class="anchor" aria-label="anchor" href="#comparison-with-sas"></a>
</h2>
<p>In <code>SAS</code>, from <code>proc mixed</code>, we are able to
generate predictions using the <code>outp</code> argument in the
<code>model</code> statement. For example:</p>
<pre class="sas"><code>PROC MIXED DATA = fev_data method=reml;
  CLASS RACE(ref = 'Asian') AVISIT(ref = 'VIS4') SEX(ref = 'Male') ARMCD(ref = 'PBO') USUBJID;
  MODEL FEV1 = ARMCD / ddfm=Satterthewaite solution chisq outp=pred;
  REPEATED AVISIT / subject=USUBJID type=un r rcorr;
  LSMEANS ARMCD / pdiff=all cl alpha=0.05 slice=AVISIT;
RUN;</code></pre>
<p>However, there are some differences between the <code>SAS</code>
implementation and our <code>mmrm</code> package, described as
follows:</p>
<ol style="list-style-type: decimal">
<li>While <code>mmrm</code> and <code>SAS</code> both provide predicted
means (conditional on other observations) for unobserved records,
<code>SAS</code> also provides predicted means for observed records
while <code>mmrm</code> does not. The rationale is that in the
<code>mmrm</code> package we want to be consistent with the notion of
predictions conditional on the observed records - which means that
observed records are observed and therefore there is no prediction
uncertainty anymore.</li>
<li>The prediction standard error is different between <code>mmrm</code>
and <code>SAS</code>. While in <code>SAS</code> the prediction standard
error is conditional on the estimated variance parameters <span class="math inline">\(\theta\)</span>, in <code>mmrm</code> the marginal
prediction standard error is provided. The rationale is that in the
<code>mmrm</code> package we want to take into account the full
uncertainty about parameter estimates including <span class="math inline">\(\theta\)</span>.</li>
<li>The prediction intervals in <code>SAS</code> are based on the t
distribution, while currently in <code>mmrm</code> we use the normal
distribution. We will be considering an extension towards using the t
distribution in the future and welcome feedback on this detail.</li>
</ol>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Daniel Sabanes Bove, Julia Dedic, Doug Kelkhoff, Kevin Kunzmann, Brian Matthew Lang, Liming Li, Christian Stock, Ya Wang, Dan James, Jonathan Sidi, Daniel D. Sjoberg, Boehringer Ingelheim Ltd., Gilead Sciences, Inc., F. Hoffmann-La Roche AG, Merck Sharp &amp; Dohme, Inc., AstraZeneca plc.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
